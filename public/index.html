<!DOCTYPE HTML>
<html ng-app="App">
	<head>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>


		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
    <script src="/iframe-resizer/js/iframeResizer.min.js"></script>
		<script>
var App = angular.module('App', []);

function resizeIframe(obj) {
    obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
  }

function hCtrl($scope, $http) {
	console.log($scope);
  	$http.get('/tags')
       .then(function(res){
          $scope.tags = res.data;                
          console.log($scope.tags);
        });

    $scope.selectTag = function(tag) {
    	$http.get('/tag_usage/' + tag)
       .then(function(res){
          $scope.tag_usage = res.data;                
        });
    };

    $scope.selectUsage = function(tu) {
    	if ($scope.inProgress)
    		return;
    	$scope.selectedUsage = tu;
    	$scope.inProgress = true;
    	$http.get('/page/' + tu.page)
       	.then(function(res){
       		$scope.inProgress = false;
          $scope.page = res.data;
          $scope.html = '<head>' + 
          '<base href="'+ $scope.page.url + '" target="_blank">' +
          //  $scope.page.head.trim() + 
          '</head><body>' + 
          //$("<div/>").html(tu.contents).text() + 
          tu.contents + '<h1>123</h1>' +
          '</body>';
          console.log($scope.html);
          console.log($scope.page.head.trim());
      	  //$('#preview').contents().find('html').get().innerHTML = $scope.html;
          $('#preview').contents().find('html').html($scope.html);
          //var obj = $('#preview').get(0);
          //console.log(obj);
          //obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
        }, function(err) {
        	console.log('error');
          $scope.inProgress = false;
        });
    };

    $scope.selectTag('input');
}

App.controller('hCtrl', hCtrl);
		</script>
	</head>
	<body ng-controller="hCtrl">
		<h1>HTML Observatory</h1>
		<div style="margin: 0px;" class="row">
			<div class="col-md-2">
				<ul class="nav nav-pills nav-stacked">
				  <li ng-repeat="tag in tags" ng-click="selectTag(tag)" role="presentation"><a href="#">{{tag}}</a></li>
				</ul>
			</div>
			<div class="col-md-4">
				<ul class="nav nav-pills nav-stacked">
				  <li ng-repeat="tu in tag_usage" ng-click="selectUsage(tu)" role="presentation"><a href="#">{{tu.element}}</a></li>
				</ul>
			</div>
			<div class="col-md-6">
				{{selectedUsage.contents}}
				<br>
				<hr>
				<div>
					<iframe id="preview" style="width: 100%;" onload='javascript:resizeIframe(this);'>
					</iframe>
				</div>
				<a href="{{page.url}}">{{page.url}}</a>
			</div>
	</body>
</html>